<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: space-between;
        }
        #contacts {
            width: 20%;
            border-right: 1px solid #ccc;
            padding: 10px;
        }
        #messages {
            width: 60%;
            padding: 10px;
        }
        .profile-picture {
            width: 50px;
            height: 50px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div id="contacts">
        <h3>Contacts</h3>
        <div id="contact-list"></div>
        <input type="file" id="upload-pfp" accept="image/*">
    </div>
    <div id="messages">
        <h3>Messages</h3>
        <div id="message-list"></div>
        <input type="text" id="message-input" placeholder="Type a message">
        <button id="send-message">Send</button>
    </div>
    <div id="friend-code" style="position: absolute; top: 10px; right: 10px;"></div>

    <script>
        async function getIP() {
            const response = await fetch('https://api.ipify.org?format=json');
            const data = await response.json();
            return data.ip;
        }

        function generateFriendCode() {
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const letter = letters.charAt(Math.floor(Math.random() * letters.length));
            const numbers = Array(6).fill(0).map(() => Math.floor(Math.random() * 10)).join('');
            return `${letter}-${numbers.substring(0, 3)}-${numbers.substring(3, 6)}`;
        }

        function updateContacts(user) {
            const contactList = document.getElementById('contact-list');
            contactList.innerHTML = '';
            user.contacts.forEach(contact => {
                const contactElement = document.createElement('div');
                contactElement.innerHTML = `
                    <img src="${contact.profilePicture}" class="profile-picture" alt="Profile Picture">
                    <span>${contact.name}</span>
                `;
                contactList.appendChild(contactElement);
            });
        }

        function addMessage(message, isSentByUser = true) {
            const messageList = document.getElementById('message-list');
            const messageElement = document.createElement('div');
            messageElement.innerText = message;
            messageElement.style.textAlign = isSentByUser ? 'right' : 'left';
            messageList.appendChild(messageElement);
        }

        async function main() {
            const ip = await getIP();
            let user = localStorage.getItem(ip);
            if (!user) {
                const name = prompt('Enter your name:');
                const friendCode = generateFriendCode();
                user = { ip, name, friendCode, contacts: [], profilePicture: 'https://i.pinimg.com/736x/cb/45/72/cb4572f19ab7505d552206ed5dfb3739.jpg' };
                localStorage.setItem(ip, JSON.stringify(user));
            } else {
                user = JSON.parse(user);
            }
            document.getElementById('friend-code').innerText = `Friend Code: ${user.friendCode}`;
            updateContacts(user);

            document.getElementById('upload-pfp').addEventListener('change', function(event) {
                const reader = new FileReader();
                reader.onload = function() {
                    user.profilePicture = reader.result;
                    localStorage.setItem(ip, JSON.stringify(user));
                    updateContacts(user);
                }
                reader.readAsDataURL(event.target.files[0]);
            });

            document.getElementById('send-message').addEventListener('click', function() {
                const messageInput = document.getElementById('message-input');
                const message = messageInput.value;
                if (message) {
                    addMessage(message);
                    messageInput.value = '';
                    // Here you would also send the message to the server and broadcast to other users
                }
            });
        }

        main();
    </script>
</body>
</html>
